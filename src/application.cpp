#include "application.h"

#include "global_objects.h"
#include "js_methods.h"

#include "thread.h"
#include "thread_pool.h"

static const struct {
  unsigned int 	 width;
  unsigned int 	 height;
  unsigned int 	 bytes_per_pixel; /* 2:RGB16, 3:RGB, 4:RGBA */
  unsigned char	 pixel_data[32 * 32 * 4 + 1];
} game_icon = {
  32, 32, 4,
  "\240\240\240\377\240\240\240\377\240\240\240\377\240\240\240\377\240\240"
  "\240\377\240\240\240\377\240\240\240\377\240\240\240\377\200\200\200\377"
  "\200\200\200\377\200\200\200\377\200\200\200\377\200\200\200\377\200\200"
  "\200\377\200\200\200\377\200\200\200\377\240\240\240\377\240\240\240\377"
  "\240\240\240\377\240\240\240\377\240\240\240\377\240\240\240\377\240\240"
  "\240\377\240\240\240\377\200\200\200\377\200\200\200\377\200\200\200\377"
  "\200\200\200\377\200\200\200\377\200\200\200\377\200\200\200\377\200\200"
  "\200\377\240\240\240\377\240\240\240\377\240\240\240\377\240\240\240\377"
  "\240\240\240\377\240\240\240\377\240\240\240\377\240\240\240\377\200\200"
  "\200\377\200\200\200\377\200\200\200\377\200\200\200\377\200\200\200\377"
  "\200\200\200\377\200\200\200\377\200\200\200\377\240\240\240\377\240\240"
  "\240\377\240\240\240\377\240\240\240\377\240\240\240\377\240\240\240\377"
  "\240\240\240\377\240\240\240\377\200\200\200\377\200\200\200\377\200\200"
  "\200\377\200\200\200\377\200\200\200\377\200\200\200\377\200\200\200\377"
  "\200\200\200\377\240\240\240\377\240\240\240\377\240\240\240\377\240\240"
  "\240\377\240\240\240\377\240\240\240\377\240\240\240\377\240\240\240\377"
  "\200\200\200\377\200\200\200\377\200\200\200\377\200\200\200\377\200\200"
  "\200\377\200\200\200\377\200\200\200\377\200\200\200\377\240\240\240\377"
  "\240\240\240\377\240\240\240\377\240\240\240\377\240\240\240\377\240\240"
  "\240\377\240\240\240\377\240\240\240\377\200\200\200\377\200\200\200\377"
  "\200\200\200\377\200\200\200\377\200\200\200\377\200\200\200\377\200\200"
  "\200\377\200\200\200\377\240\240\240\377\240\240\240\377\240\240\240\377"
  "\240\240\240\377\240\240\240\377\240\240\240\377\240\240\240\377\240\240"
  "\240\377\200\200\200\377\200\200\200\377\200\200\200\377\200\200\200\377"
  "\200\200\200\377\200\200\200\377\200\200\200\377\200\200\200\377\240\240"
  "\240\377\240\240\240\377\240\240\240\377\240\240\240\377\240\240\240\377"
  "\240\240\240\377\240\240\240\377\240\240\240\377\200\200\200\377\200\200"
  "\200\377\200\200\200\377\200\200\200\377\200\200\200\377\200\200\200\377"
  "\200\200\200\377\200\200\200\377\240\240\240\377\240\240\240\377\240\240"
  "\240\377\240\240\240\377\240\240\240\377\240\240\240\377\240\240\240\377"
  "\240\240\240\377\200\200\200\377\200\200\200\377\200\200\200\377\200\200"
  "\200\377\200\200\200\377\200\200\200\377\200\200\200\377\200\200\200\377"
  "\240\240\240\377\240\240\240\377\240\240\240\377\240\240\240\377\240\240"
  "\240\377\240\240\240\377\240\240\240\377\240\240\240\377\200\200\200\377"
  "\200\200\200\377\200\200\200\377\200\200\200\377\200\200\200\377\200\200"
  "\200\377\200\200\200\377\200\200\200\377\240\240\240\377\240\240\240\377"
  "\240\240\240\377\240\240\240\377\240\240\240\377\240\240\240\377\240\240"
  "\240\377\240\240\240\377\200\200\200\377\200\200\200\377\200\200\200\377"
  "\200\200\200\377\200\200\200\377\200\200\200\377\200\200\200\377\200\200"
  "\200\377\240\240\240\377\240\240\240\377\240\240\240\377\240\240\240\377"
  "\240\240\240\377\240\240\240\377\240\240\240\377\240\240\240\377\200\200"
  "\200\377\200\200\200\377\200\200\200\377\200\200\200\377\200\200\200\377"
  "\200\200\200\377\200\200\200\377\200\200\200\377\240\240\240\377\240\240"
  "\240\377\240\240\240\377\240\240\240\377\240\240\240\377\240\240\240\377"
  "\240\240\240\377\240\240\240\377\200\200\200\377\200\200\200\377\200\200"
  "\200\377\200\200\200\377\200\200\200\377\200\200\200\377\200\200\200\377"
  "\200\200\200\377\240\240\240\377\240\240\240\377\240\240\240\377\240\240"
  "\240\377\240\240\240\377\240\240\240\377\240\240\240\377\240\240\240\377"
  "\200\200\200\377\200\200\200\377\200\200\200\377\200\200\200\377\200\200"
  "\200\377\200\200\200\377\200\200\200\377\200\200\200\377\240\240\240\377"
  "\240\240\240\377\240\240\240\377\240\240\240\377\240\240\240\377\240\240"
  "\240\377\240\240\240\377\240\240\240\377\200\200\200\377\200\200\200\377"
  "\200\200\200\377\200\200\200\377\200\200\200\377\200\200\200\377\200\200"
  "\200\377\200\200\200\377\240\240\240\377\240\240\240\377\240\240\240\377"
  "\240\240\240\377\240\240\240\377\240\240\240\377\240\240\240\377\240\240"
  "\240\377\200\200\200\377\200\200\200\377\200\200\200\377\200\200\200\377"
  "\200\200\200\377\200\200\200\377\200\200\200\377\200\200\200\377\200\200"
  "\200\377\200\200\200\377\200\200\200\377\200\200\200\377\200\200\200\377"
  "\200\200\200\377\200\200\200\377\200\200\200\377\240\240\240\377\240\240"
  "\240\377\240\240\240\377\240\240\240\377\240\240\240\377\240\240\240\377"
  "\240\240\240\377\240\240\240\377\200\200\200\377\200\200\200\377\200\200"
  "\200\377\200\200\200\377\200\200\200\377\200\200\200\377\200\200\200\377"
  "\200\200\200\377\240\240\240\377\240\240\240\377\240\240\240\377\240\240"
  "\240\377\240\240\240\377\240\240\240\377\240\240\240\377\240\240\240\377"
  "\200\200\200\377\200\200\200\377\200\200\200\377\200\200\200\377\200\200"
  "\200\377\200\200\200\377\200\200\200\377\200\200\200\377\240\240\240\377"
  "\240\240\240\377\240\240\240\377\240\240\240\377\240\240\240\377\272\272"
  "\272\377\337\337\337\377\362\362\362\377\371\371\371\377\354\354\354\377"
  "\314\314\314\377\220\220\220\377\200\200\200\377\200\200\200\377\200\200"
  "\200\377\207\207\207\377\305\305\305\377\346\346\346\377\365\365\365\377"
  "\371\371\371\377\355\355\355\377\314\314\314\377\243\243\243\377\240\240"
  "\240\377\200\200\200\377\200\200\200\377\200\200\200\377\200\200\200\377"
  "\200\200\200\377\200\200\200\377\200\200\200\377\200\200\200\377\240\240"
  "\240\377\240\240\240\377\240\240\240\377\240\240\240\377\265\265\265\377"
  "\377\377\377\377\377\377\377\377\377\377\377\377\377\377\377\377\377\377"
  "\377\377\377\377\377\377\367\367\367\377\224\224\224\377\200\200\200\377"
  "\200\200\200\377\313\313\313\377\377\377\377\377\377\377\377\377\377\377"
  "\377\377\377\377\377\377\377\377\377\377\377\377\377\377\355\355\355\377"
  "\243\243\243\377\200\200\200\377\200\200\200\377\200\200\200\377\200\200"
  "\200\377\200\200\200\377\200\200\200\377\200\200\200\377\200\200\200\377"
  "\240\240\240\377\240\240\240\377\240\240\240\377\240\240\240\377\263\263"
  "\263\377\336\336\336\377\273\273\273\377\251\251\251\377\203\203\203\377"
  "\224\224\224\377\323\323\323\377\377\377\377\377\313\313\313\377\200\200"
  "\200\377\200\200\200\377\302\302\302\377\327\327\327\377\267\267\267\377"
  "\250\250\250\377\243\243\243\377\273\273\273\377\364\364\364\377\377\377"
  "\377\377\306\306\306\377\201\201\201\377\341\341\341\377\370\370\370\377"
  "\222\222\222\377\200\200\200\377\200\200\200\377\200\200\200\377\262\262"
  "\262\377\377\377\377\377\317\317\317\377\240\240\240\377\240\240\240\377"
  "\240\240\240\377\240\240\240\377\240\240\240\377\240\240\240\377\200\200"
  "\200\377\200\200\200\377\220\220\220\377\377\377\377\377\321\321\321\377"
  "\200\200\200\377\200\200\200\377\200\200\200\377\240\240\240\377\240\240"
  "\240\377\240\240\240\377\240\240\240\377\240\240\240\377\277\277\277\377"
  "\377\377\377\377\323\323\323\377\200\200\200\377\216\216\216\377\366\366"
  "\366\377\346\346\346\377\203\203\203\377\200\200\200\377\224\224\224\377"
  "\371\371\371\377\347\347\347\377\240\240\240\377\240\240\240\377\240\240"
  "\240\377\240\240\240\377\240\240\240\377\240\240\240\377\240\240\240\377"
  "\201\201\201\377\221\221\221\377\320\320\320\377\377\377\377\377\252\252"
  "\252\377\200\200\200\377\200\200\200\377\200\200\200\377\240\240\240\377"
  "\240\240\240\377\240\240\240\377\240\240\240\377\240\240\240\377\273\273"
  "\273\377\377\377\377\377\304\304\304\377\200\200\200\377\200\200\200\377"
  "\247\247\247\377\377\377\377\377\311\311\311\377\203\203\203\377\350\350"
  "\350\377\365\365\365\377\251\251\251\377\240\240\240\377\240\240\240\377"
  "\240\240\240\377\240\240\240\377\240\240\240\377\301\301\301\377\377\377"
  "\377\377\377\377\377\377\377\377\377\377\355\355\355\377\260\260\260\377"
  "\200\200\200\377\200\200\200\377\200\200\200\377\200\200\200\377\240\240"
  "\240\377\240\240\240\377\240\240\240\377\240\240\240\377\240\240\240\377"
  "\347\347\347\377\361\361\361\377\242\242\242\377\200\200\200\377\200\200"
  "\200\377\200\200\200\377\312\312\312\377\377\377\377\377\341\341\341\377"
  "\377\377\377\377\246\246\246\377\240\240\240\377\240\240\240\377\240\240"
  "\240\377\240\240\240\377\240\240\240\377\240\240\240\377\301\301\301\377"
  "\377\377\377\377\377\377\377\377\377\377\377\377\371\371\371\377\310\310"
  "\310\377\202\202\202\377\200\200\200\377\200\200\200\377\200\200\200\377"
  "\240\240\240\377\240\240\240\377\240\240\240\377\240\240\240\377\334\334"
  "\334\377\370\370\370\377\260\260\260\377\240\240\240\377\240\240\240\377"
  "\240\240\240\377\240\240\240\377\242\242\242\377\361\361\361\377\377\377"
  "\377\377\327\327\327\377\240\240\240\377\200\200\200\377\200\200\200\377"
  "\200\200\200\377\200\200\200\377\200\200\200\377\200\200\200\377\200\200"
  "\200\377\200\200\200\377\242\242\242\377\257\257\257\377\333\333\333\377"
  "\377\377\377\377\326\326\326\377\240\240\240\377\240\240\240\377\240\240"
  "\240\377\200\200\200\377\200\200\200\377\203\203\203\377\327\327\327\377"
  "\364\364\364\377\230\230\230\377\200\200\200\377\200\200\200\377\240\240"
  "\240\377\240\240\240\377\240\240\240\377\263\263\263\377\374\374\374\377"
  "\377\377\377\377\347\347\347\377\240\240\240\377\200\200\200\377\200\200"
  "\200\377\200\200\200\377\200\200\200\377\200\200\200\377\200\200\200\377"
  "\200\200\200\377\200\200\200\377\240\240\240\377\240\240\240\377\240\240"
  "\240\377\361\361\361\377\366\366\366\377\240\240\240\377\240\240\240\377"
  "\240\240\240\377\200\200\200\377\211\211\211\377\342\342\342\377\362\362"
  "\362\377\225\225\225\377\200\200\200\377\200\200\200\377\200\200\200\377"
  "\240\240\240\377\240\240\240\377\244\244\244\377\361\361\361\377\364\364"
  "\364\377\314\314\314\377\377\377\377\377\317\317\317\377\200\200\200\377"
  "\200\200\200\377\200\200\200\377\200\200\200\377\200\200\200\377\200\200"
  "\200\377\200\200\200\377\200\200\200\377\240\240\240\377\240\240\240\377"
  "\240\240\240\377\363\363\363\377\373\373\373\377\240\240\240\377\240\240"
  "\240\377\240\240\240\377\220\220\220\377\354\354\354\377\357\357\357\377"
  "\221\221\221\377\200\200\200\377\200\200\200\377\200\200\200\377\200\200"
  "\200\377\240\240\240\377\240\240\240\377\335\335\335\377\375\375\375\377"
  "\267\267\267\377\240\240\240\377\336\336\336\377\375\375\375\377\236\236"
  "\236\377\200\200\200\377\200\200\200\377\200\200\200\377\303\303\303\377"
  "\273\273\273\377\225\225\225\377\204\204\204\377\244\244\244\377\263\263"
  "\263\377\337\337\337\377\377\377\377\377\346\346\346\377\240\240\240\377"
  "\240\240\240\377\262\262\262\377\363\363\363\377\354\354\354\377\216\216"
  "\216\377\200\200\200\377\200\200\200\377\200\200\200\377\200\200\200\377"
  "\200\200\200\377\240\240\240\377\304\304\304\377\377\377\377\377\321\321"
  "\321\377\240\240\240\377\240\240\240\377\245\245\245\377\362\362\362\377"
  "\360\360\360\377\210\210\210\377\200\200\200\377\200\200\200\377\317\317"
  "\317\377\377\377\377\377\377\377\377\377\377\377\377\377\377\377\377\377"
  "\377\377\377\377\377\377\377\377\370\370\370\377\261\261\261\377\240\240"
  "\240\377\240\240\240\377\340\340\340\377\377\377\377\377\377\377\377\377"
  "\377\377\377\377\377\377\377\377\377\377\377\377\377\377\377\377\377\377"
  "\377\377\323\323\323\377\255\255\255\377\372\372\372\377\350\350\350\377"
  "\240\240\240\377\240\240\240\377\240\240\240\377\240\240\240\377\264\264"
  "\264\377\374\374\374\377\327\327\327\377\200\200\200\377\200\200\200\377"
  "\211\211\211\377\272\272\272\377\343\343\343\377\367\367\367\377\373\373"
  "\373\377\357\357\357\377\326\326\326\377\253\253\253\377\240\240\240\377"
  "\240\240\240\377\240\240\240\377\340\340\340\377\377\377\377\377\377\377"
  "\377\377\377\377\377\377\377\377\377\377\377\377\377\377\377\377\377\377"
  "\377\377\377\377\323\323\323\377\240\240\240\377\240\240\240\377\240\240"
  "\240\377\240\240\240\377\240\240\240\377\240\240\240\377\240\240\240\377"
  "\240\240\240\377\200\200\200\377\200\200\200\377\200\200\200\377\200\200"
  "\200\377\200\200\200\377\200\200\200\377\200\200\200\377\200\200\200\377"
  "\240\240\240\377\240\240\240\377\240\240\240\377\240\240\240\377\240\240"
  "\240\377\240\240\240\377\240\240\240\377\240\240\240\377\200\200\200\377"
  "\200\200\200\377\200\200\200\377\200\200\200\377\200\200\200\377\200\200"
  "\200\377\200\200\200\377\200\200\200\377\240\240\240\377\240\240\240\377"
  "\240\240\240\377\240\240\240\377\240\240\240\377\240\240\240\377\240\240"
  "\240\377\240\240\240\377\200\200\200\377\200\200\200\377\200\200\200\377"
  "\200\200\200\377\200\200\200\377\200\200\200\377\200\200\200\377\200\200"
  "\200\377\240\240\240\377\240\240\240\377\240\240\240\377\240\240\240\377"
  "\240\240\240\377\240\240\240\377\240\240\240\377\240\240\240\377\200\200"
  "\200\377\200\200\200\377\200\200\200\377\200\200\200\377\200\200\200\377"
  "\200\200\200\377\200\200\200\377\200\200\200\377\200\200\200\377\200\200"
  "\200\377\200\200\200\377\200\200\200\377\200\200\200\377\200\200\200\377"
  "\200\200\200\377\200\200\200\377\240\240\240\377\240\240\240\377\240\240"
  "\240\377\240\240\240\377\240\240\240\377\240\240\240\377\240\240\240\377"
  "\240\240\240\377\200\200\200\377\200\200\200\377\200\200\200\377\200\200"
  "\200\377\200\200\200\377\200\200\200\377\200\200\200\377\200\200\200\377"
  "\240\240\240\377\240\240\240\377\240\240\240\377\240\240\240\377\240\240"
  "\240\377\240\240\240\377\240\240\240\377\240\240\240\377\200\200\200\377"
  "\200\200\200\377\200\200\200\377\200\200\200\377\200\200\200\377\200\200"
  "\200\377\200\200\200\377\200\200\200\377\240\240\240\377\240\240\240\377"
  "\240\240\240\377\240\240\240\377\240\240\240\377\240\240\240\377\240\240"
  "\240\377\240\240\240\377\200\200\200\377\200\200\200\377\200\200\200\377"
  "\200\200\200\377\200\200\200\377\200\200\200\377\200\200\200\377\200\200"
  "\200\377\240\240\240\377\240\240\240\377\240\240\240\377\240\240\240\377"
  "\240\240\240\377\240\240\240\377\240\240\240\377\240\240\240\377\200\200"
  "\200\377\200\200\200\377\200\200\200\377\200\200\200\377\200\200\200\377"
  "\200\200\200\377\200\200\200\377\200\200\200\377\240\240\240\377\240\240"
  "\240\377\240\240\240\377\240\240\240\377\240\240\240\377\240\240\240\377"
  "\240\240\240\377\240\240\240\377\200\200\200\377\200\200\200\377\200\200"
  "\200\377\200\200\200\377\200\200\200\377\200\200\200\377\200\200\200\377"
  "\200\200\200\377\240\240\240\377\240\240\240\377\240\240\240\377\240\240"
  "\240\377\240\240\240\377\240\240\240\377\240\240\240\377\240\240\240\377"
  "\200\200\200\377\200\200\200\377\200\200\200\377\200\200\200\377\200\200"
  "\200\377\200\200\200\377\200\200\200\377\200\200\200\377\240\240\240\377"
  "\240\240\240\377\240\240\240\377\240\240\240\377\240\240\240\377\240\240"
  "\240\377\240\240\240\377\240\240\240\377\200\200\200\377\200\200\200\377"
  "\200\200\200\377\200\200\200\377\200\200\200\377\200\200\200\377\200\200"
  "\200\377\200\200\200\377\240\240\240\377\240\240\240\377\240\240\240\377"
  "\240\240\240\377\240\240\240\377\240\240\240\377\240\240\240\377\240\240"
  "\240\377\200\200\200\377\200\200\200\377\200\200\200\377\200\200\200\377"
  "\200\200\200\377\200\200\200\377\200\200\200\377\200\200\200\377\240\240"
  "\240\377\240\240\240\377\240\240\240\377\240\240\240\377\240\240\240\377"
  "\240\240\240\377\240\240\240\377\240\240\240\377\200\200\200\377\200\200"
  "\200\377\200\200\200\377\200\200\200\377\200\200\200\377\200\200\200\377"
  "\200\200\200\377\200\200\200\377\240\240\240\377\240\240\240\377\240\240"
  "\240\377\240\240\240\377\240\240\240\377\240\240\240\377\240\240\240\377"
  "\240\240\240\377\200\200\200\377\200\200\200\377\200\200\200\377\200\200"
  "\200\377\200\200\200\377\200\200\200\377\200\200\200\377\200\200\200\377"
  "\240\240\240\377\240\240\240\377\240\240\240\377\240\240\240\377\240\240"
  "\240\377\240\240\240\377\240\240\240\377\240\240\240\377\200\200\200\377"
  "\200\200\200\377\200\200\200\377\200\200\200\377\200\200\200\377\200\200"
  "\200\377\200\200\200\377\200\200\200\377\240\240\240\377\240\240\240\377"
  "\240\240\240\377\240\240\240\377\240\240\240\377\240\240\240\377\240\240"
  "\240\377\240\240\240\377\200\200\200\377\200\200\200\377\200\200\200\377"
  "\200\200\200\377\200\200\200\377\200\200\200\377\200\200\200\377\200\200"
  "\200\377\240\240\240\377\240\240\240\377\240\240\240\377\240\240\240\377"
  "\240\240\240\377\240\240\240\377\240\240\240\377\240\240\240\377\200\200"
  "\200\377\200\200\200\377\200\200\200\377\200\200\200\377\200\200\200\377"
  "\200\200\200\377\200\200\200\377\200\200\200\377\240\240\240\377\240\240"
  "\240\377\240\240\240\377\240\240\240\377\240\240\240\377\240\240\240\377"
  "\240\240\240\377\240\240\240\377\200\200\200\377\200\200\200\377\200\200"
  "\200\377\200\200\200\377\200\200\200\377\200\200\200\377\200\200\200\377"
  "\200\200\200\377\240\240\240\377\240\240\240\377\240\240\240\377\240\240"
  "\240\377\240\240\240\377\240\240\240\377\240\240\240\377\240\240\240\377"
  "\200\200\200\377\200\200\200\377\200\200\200\377\200\200\200\377\200\200"
  "\200\377\200\200\200\377\200\200\200\377\200\200\200\377\240\240\240\377"
  "\240\240\240\377\240\240\240\377\240\240\240\377\240\240\240\377\240\240"
  "\240\377\240\240\240\377\240\240\240\377",
};

namespace game
{

void application::run()
{
	LOG_WARNING << "We are here";
	ships[101] = std::shared_ptr<ship>(new ship(101));

	thread_ptr thread_update(new thread(&game::application::update, this));
	thread_pool_add(thread_update);

	while (m_window.isOpen())
	{
		sf::Event event;

		while (m_window.pollEvent(event))
		{
			switch (event.type)
			{
			case sf::Event::Closed:
				m_window.close();
				break;
			default:
				break;
			}
		}

		//auto update_function = std::bind(&game::ship::update, &ships[101]);
		//ships[101].get()->reset_acted();
		//thread_ptr thread(new game::thread(&game::ship::update, ships[101].get()));
		//thread_pool_add(thread, sf::seconds(1));

		//thread->wait();

		m_window.clear();
		m_window.draw(*ships[101].get());
		m_window.display();
	}
	thread_update->terminate();
}

application::application(int argc, char* argv[])
{
	LOG_INFO << "---====== Starting up =======---";
	for (int i = 0; i < argc; i++)
	{
		m_args.push_back(argv[i]);
	}

	m_window.create(sf::VideoMode(640, 480), "Viper Steel");
	m_window.setIcon(game_icon.width, game_icon.height, game_icon.pixel_data);
	m_window.setVerticalSyncEnabled(true);
}

void application::update()
{
	while (1)
	{
		for(auto ship : ships)
		{
			ship.second.get()->reset_acted();
			// ship.second.get()->update();
			thread_ptr thread(new game::thread(&game::ship::update, ship.second.get()));
			thread_pool_add(thread, sf::seconds(1));
			thread->wait();
		}
		sf::sleep(sf::milliseconds(50));
	}
}

application::~application()
{
	LOG_INFO << "---====== Shutting down =======---";
}

} /* namespace game */
